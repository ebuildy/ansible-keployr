##
# Generated by keployr
##

KEPLOYR_VIA_DOCKER ?= docker run -ti -e KEPLOYR_USER=gitlab-runner -e KEPLOYR_USER_UID=999 -e INFRA_ENV=$$INFRA_ENV -e KEPLOYR_FILE=keployr.yaml --rm -v $$PWD:/app -w /app/src keployr:latest keployr
KEPLOYR_BIN ?= "keployr"
KEPLOYR_FILE ?= "./src/keployr.yaml"
KEPLOYR_SKIP_TAGS ?= ""
KEPLOYR_TAGS ?= ""

{% for env in keployr_devop_envs %}
# ------------------------------------------------------------------------------
# env: {{ env | upper }}
# ------------------------------------------------------------------------------

{% if keployr_devop.actions is defined %}
{% for action in keployr_devop.actions %}
.PHONY: {{ env.env }}/{{ action.name | lower | replace(' ', '-') }}
{{ env.env }}/{{ action.name | lower | replace(' ', '-') }}: {% if action.actions is defined %}{% for sub_action in action.actions %}{{ env.env }}/{{ sub_action | replace('.', '/') }} {% endfor %}{% endif %}

	@echo "env: {{ env.env }} stack: {{ keployr_stack }} action: {{ action.name }}"
{% if action.tags is defined %}
	INFRA_ENV={{ env.include_file }} ${KEPLOYR_BIN} {{ action.tags }}
{% endif %}

{% endfor %}

{% endif %}

{% for service in keployr_devop.services %}
{% if service.urls is defined %}
{% for url in service.urls %}
.PHONY: {{ env.env }}/{{ service.name | lower | replace(' ', '-') }}/url-{{ url.ingress }}
{{ env.env }}/{{ service.name | lower | replace(' ', '-') }}/url-{{ url.ingress }}:
	@echo "https://{{ url.ingress }}{{ env.dns_suffix}}"
	open "https://{{ url.ingress }}{{ env.dns_suffix}}"
{% endfor %}
{% endif %}
{% if service.actions is defined %}
# ------------------------------------------------------------------------------
# Stack "{{ keployr_stack }}" > Service "{{ service.name }}"
# ------------------------------------------------------------------------------
{% for action in service.actions %}
.PHONY: {{ env.env }}/{{ service.name | lower | replace(' ', '-') }}/{{ action.name | lower | replace(' ', '-') }}
{{ env.env }}/{{ service.name | lower | replace(' ', '-') }}/{{ action.name | lower | replace(' ', '-') }}:
	@echo "env: {{ env.env }} stack: {{ keployr_stack }} service:{{ service.name }}  action: {{ action.name }}"
	INFRA_ENV={{ env.include_file }} ${KEPLOYR_BIN} {{ action.tags }}

{% endfor %}
{% endif %}

{% endfor %}
{% endfor %}

CIDRE_PLAYBOOK_FILE ?= ./ci/playbook.yaml

ci/build-makefile-readme:
	${KEPLOYR_BIN} devop_build

define call_cidre
    ansible-playbook ${CIDRE_PLAYBOOK_FILE} --tags $(1)
endef

cidre/bump/patch:
	$(call call_cidre,cidre_bump_patch)

cidre/bump/minor:
	$(call call_cidre,cidre_bump_minor)

cidre/bump/major:
	$(call call_cidre,cidre_bump_major)

cidre/ms_close:
	$(call call_cidre,cidre_ms_close)
