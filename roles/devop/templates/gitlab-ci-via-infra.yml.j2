##
# Generated by keployr - {{ ansible_date_time.iso8601 }}
##

include:
- project: 'product/analytic/infra/keployr'
  ref: master
  file: gitlab-ci-keployr.yml

stages:
- {{ keployr_stack.name | lower | replace(' ', '-') }}
{% for service in keployr_stack.services -%}
- {{ keployr_stack.name | lower | replace(' ', '-') }}-{{ service.name | lower | replace(' ', '-') }}
{% endfor -%}

{% for service in keployr_stack.services %}
{% if service.actions is defined %}
# ------------------------------------------------------------------------------
# Stack "{{ keployr_stack.name }}" > Service "{{ service.name }}"
# ------------------------------------------------------------------------------
{% for action in service.actions %}
.{{ service.name | lower | replace(' ', '-') }}-{{ action.name | lower | replace(' ', '-') }}:
  extends:
  - .keployr
  - .when_manual
  stage: {{ keployr_stack.name | lower | replace(' ', '-') }}-{{ service.name | lower | replace(' ', '-') }}
  dependencies: []
  variables:
    KEPLOYR_TAGS: "{{ action.tags }}"

{% endfor %}
{% endif %}

{% endfor %}


{% for env in infra_envs %}
# ------------------------------------------------------------------------------
# env: {{ env | upper }}
# ------------------------------------------------------------------------------

{% if keployr_stack.actions is defined %}
{% for action in keployr_stack.actions %}

{{ env.env }}-{{ keployr_stack.name | lower | replace(' ', '-') }}-{{ action.name | lower | replace(' ', '-') }}:
  extends:
  - .keployr
  - .when_manual
  - .env_{{ env.env }}
  environment:
    name: {{ env.env }}/{{ keployr_stack.name | lower | replace(' ', '-')}}
  stage: {{ keployr_stack.name | lower | replace(' ', '-') }}
  dependencies: []
{% if action.tags is defined %}
  variables:
    KEPLOYR_TAGS: "{{ action.tags }}"
{% elif action.actions is defined %}
  script:
{% for sub_action in action.actions %}
  - make {{ env.env }}/{{ sub_action | replace('.', '/') }}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}

{% for service in keployr_stack.services %}
{% if service.actions is defined %}
# ------------------------------------------------------------------------------
# Stack "{{ keployr_stack.name }}" > Service "{{ service.name }}"
# ------------------------------------------------------------------------------
{% for action in service.actions %}

{{ env.env }}-{{ service.name | lower | replace(' ', '-') }}-{{ action.name | lower | replace(' ', '-') }}:
  extends:
  - .{{ service.name | lower | replace(' ', '-') }}-{{ action.name | lower | replace(' ', '-') }}
  - .env_{{ env.env }}
  environment:
    name: {{ env.env }}/{{ keployr_stack.name | lower | replace(' ', '-') }}/{{ service.name | lower | replace(' ', '-') }}
    {% if service.urls is defined %}url: https://{{ service.urls[0].ingress }}{{ env.dns_suffix }}{% endif %}

{% endfor %}
{% endif %}

{% endfor %}
{% endfor %}
