##
# Generated by keployr
##

# Default ansible playbook file
KEPLOYR_FILE ?= "./src/keployr.yaml"

# Default ansible tags
KEPLOYR_TAGS ?= ""

# Default env name
KEPLOYR_ENV ?= dev

# var files by env name
KEPLOYR_ENV_dev_VARS_FILE = dev.yaml
KEPLOYR_ENV_prod_VARS_FILE = prod.yaml

define keployr_fn
	KEPLOYR_ENV_VARS_FILE=$(KEPLOYR_ENV_$(KEPLOYR_ENV)_VARS_FILE) ansible-playbook ${KEPLOYR_FILE} --tags=$(1) -i localhost,
endef

###
# open URL
###
.PHONY: keployr/dev/zeppelin/url-zep
keployr/dev/zeppelin/url-zep:
	@echo "https://zep.dev"
	open "https://zep.dev"

.PHONY: keployr/prod/zeppelin/url-zep
keployr/prod/zeppelin/url-zep:
	@echo "https://zep.prod"
	open "https://zep.prod"


###
# main actions
###
.PHONY: keployr/clean
keployr/clean: 
	$(call keployr_fn,clean)

.PHONY: keployr/build
keployr/build: keployr/svc/zeppelin/build keployr/svc/argocd_apps/build 


###
# services
###
.PHONY: keployr/svc/devop/makefile
keployr/svc/devop/makefile:
	$(call keployr_fn,devop_build,makefile)

.PHONY: keployr/svc/devop/deploy
keployr/svc/devop/deploy:
	$(call keployr_fn,git_deploy)


.PHONY: keployr/svc/zeppelin/build
keployr/svc/zeppelin/build:
	$(call keployr_fn,zeppelin,server)


.PHONY: keployr/svc/argocd_apps/build
keployr/svc/argocd_apps/build:
	$(call keployr_fn,argocd_apps)



###
# utils
###

print/env:
	printenv | grep KEPLOYR

CIDRE_PLAYBOOK_FILE ?= ./ci/playbook.yaml

ci/build-makefile-readme:
	${KEPLOYR_BIN} devop_build

define call_cidre
    ansible-playbook ${CIDRE_PLAYBOOK_FILE} --tags $(1)
endef

cidre/bump/patch:
	$(call call_cidre,cidre_bump_patch)

cidre/bump/minor:
	$(call call_cidre,cidre_bump_minor)

cidre/bump/major:
	$(call call_cidre,cidre_bump_major)

cidre/ms_close:
	$(call call_cidre,cidre_ms_close)
